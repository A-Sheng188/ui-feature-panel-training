name: CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  verify-and-prepare:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. è®¾ç½®ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3. ç»“æ„éªŒè¯ï¼ˆä»…ä¿¡æ¯æ€§ï¼‰
      - name: Verify Project Structure
        run: node tools/verify_contract.js

      # 4. å•å…ƒæµ‹è¯•ï¼ˆç¡®ä¿é€šè¿‡ï¼‰
      - name: Run Unit Tests
        run: node tests/feature-panel.spec.js

      # 5. æ ¸å¿ƒï¼šç”Ÿæˆdistç›®å½•ï¼ˆæ— heredocç‰ˆæœ¬ï¼‰
      - name: Build Dist Directory
        run: |
          # ä½¿ç”¨ç°æœ‰ç”Ÿæˆå™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if [ -f "tools/gen_dist.js" ]; then
            echo "Running dist generator..."
            node tools/gen_dist.js
          fi
          
          # ç¡®ä¿distç›®å½•å­˜åœ¨
          mkdir -p dist
          
          # åˆ›å»ºåŸºç¡€HTMLæ–‡ä»¶ï¼ˆé¿å…heredocè¯­æ³•ï¼‰
          if [ ! -f "dist/index.html" ]; then
            echo "Creating deployment page..."
            
            # é€è¡Œå†™å…¥ï¼Œç¡®ä¿YAMLå®‰å…¨
            echo '<!DOCTYPE html>' > dist/index.html
            echo '<html lang="en">' >> dist/index.html
            echo '<head>' >> dist/index.html
            echo '    <meta charset="UTF-8">' >> dist/index.html
            echo '    <meta name="viewport" content="width=device-width, initial-scale=1.0">' >> dist/index.html
            echo '    <title>Feature Panel Demo</title>' >> dist/index.html
            echo '    <style>' >> dist/index.html
            echo '        body {' >> dist/index.html
            echo '            font-family: system-ui, -apple-system, sans-serif;' >> dist/index.html
            echo '            padding: 2rem;' >> dist/index.html
            echo '            max-width: 1200px;' >> dist/index.html
            echo '            margin: 0 auto;' >> dist/index.html
            echo '            line-height: 1.6;' >> dist/index.html
            echo '        }' >> dist/index.html
            echo '        .status-box {' >> dist/index.html
            echo '            background: #f0f9ff;' >> dist/index.html
            echo '            border: 2px solid #0369a1;' >> dist/index.html
            echo '            border-radius: 8px;' >> dist/index.html
            echo '            padding: 1.5rem;' >> dist/index.html
            echo '            margin: 2rem 0;' >> dist/index.html
            echo '        }' >> dist/index.html
            echo '        .success {' >> dist/index.html
            echo '            color: #059669;' >> dist/index.html
            echo '            font-weight: bold;' >> dist/index.html
            echo '        }' >> dist/index.html
            echo '    </style>' >> dist/index.html
            echo '</head>' >> dist/index.html
            echo '<body>' >> dist/index.html
            echo '    <h1>ğŸš€ Feature Panel Demo</h1>' >> dist/index.html
            echo '    <p>This is the final deployment of your FeaturePanel component.</p>' >> dist/index.html
            echo '    ' >> dist/index.html
            echo '    <div class="status-box">' >> dist/index.html
            echo '        <h2>âœ… Deployment Status</h2>' >> dist/index.html
            echo '        <p class="success">CI Workflow: PASSED</p>' >> dist/index.html
            echo '        <p class="success">GitHub Pages: ACTIVE</p>' >> dist/index.html
            echo '        <p>Generated: $(date -u)</p>' >> dist/index.html
            echo '    </div>' >> dist/index.html
            echo '    ' >> dist/index.html
            echo '    <div>' >> dist/index.html
            echo '        <h3>Next Steps:</h3>' >> dist/index.html
            echo '        <ul>' >> dist/index.html
            echo '            <li>FeaturePanel component will render here</li>' >> dist/index.html
            echo '            <li>Add interactive filtering and cards</li>' >> dist/index.html
            echo '            <li>Implement drawer for details</li>' >> dist/index.html
            echo '        </ul>' >> dist/index.html
            echo '    </div>' >> dist/index.html
            echo '    ' >> dist/index.html
            echo '    <script>' >> dist/index.html
            echo '        // FeaturePanel will be initialized here' >> dist/index.html
            echo '        console.log("FeaturePanel deployment ready");' >> dist/index.html
            echo '    </script>' >> dist/index.html
            echo '</body>' >> dist/index.html
            echo '</html>' >> dist/index.html
          fi
          
          echo "âœ… Dist directory ready"
          ls -la dist/

      # 6. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload Dist Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

      # 7. å®Œæˆæ ‡è®°
      - name: CI Success
        run: echo "âœ… CI pipeline completed successfully"
