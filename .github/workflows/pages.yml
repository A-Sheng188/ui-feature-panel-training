name: ğŸš€ Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["ğŸ”’ CI Gate"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ› ï¸ Setup Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¥ Download artifact from successful CI run
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          # ä½¿ç”¨ CI Gate ä¸­ä¸Šä¼ çš„åˆ¶å“åç§°
          name: build-artifact
      
      - name: ğŸ” æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶ç»“æ„
        id: inspect
        run: |
          echo "======================================"
          echo "ğŸ“ æ£€æŸ¥ä¸‹è½½çš„åˆ¶å“ç»“æ„"
          echo "======================================"
          pwd
          ls -la
          
          echo ""
          echo "=== æ£€æŸ¥æ˜¯å¦æœ‰ index.html æ–‡ä»¶ ==="
          find . -name "index.html" 2>/dev/null
          
          echo ""
          echo "=== æ£€æŸ¥å¸¸è§æ„å»ºç›®å½• ==="
          for dir in dist build out public; do
            if [ -d "$dir" ]; then
              echo "âœ… æ‰¾åˆ°ç›®å½•: $dir"
              ls -la "$dir/" 2>/dev/null | head -5
            else
              echo "âŒ æœªæ‰¾åˆ°ç›®å½•: $dir"
            fi
          done
      
      - name: ğŸ“¦ å‡†å¤‡éƒ¨ç½²å†…å®¹
        id: prepare
        run: |
          echo "=== ç¡®å®šéƒ¨ç½²è·¯å¾„ ==="
          
          # é¦–å…ˆæ£€æŸ¥ä¸‹è½½çš„åˆ¶å“ä¸­æ˜¯å¦æœ‰ dist ç›®å½•
          if [ -d "dist" ]; then
            echo "âœ… ä½¿ç”¨ CI Gate ç”Ÿæˆçš„ dist ç›®å½•"
            echo "DEPLOY_PATH=./dist" >> $GITHUB_ENV
          elif [ -f "index.html" ]; then
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ° dist ç›®å½•ï¼Œä½†æ ¹ç›®å½•æœ‰ index.html"
            echo "DEPLOY_PATH=./" >> $GITHUB_ENV
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯éƒ¨ç½²çš„æ–‡ä»¶ï¼Œåˆ›å»ºé»˜è®¤é¡µé¢"
            mkdir -p dist
            cat > dist/index.html << EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeaturePanel UI Training - Deployment</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .warning {
            color: #e67e22;
            font-weight: bold;
        }
        .next-steps {
            text-align: left;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ FeaturePanel UI Training</h1>
        <div class="status">
            <p class="warning">âš ï¸ æ³¨æ„ï¼šæ²¡æœ‰æ‰¾åˆ° CI Gate ç”Ÿæˆçš„æ„å»ºæ–‡ä»¶</p>
            <p>è¿™æ˜¯ç”± GitHub Pages å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆçš„é»˜è®¤é¡µé¢ã€‚</p>
        </div>
        <p>è¯·æ£€æŸ¥ CI Gate å·¥ä½œæµæ˜¯å¦æ­£ç¡®æ„å»ºå¹¶ä¸Šä¼ äº†åˆ¶å“ã€‚</p>
        
        <div class="next-steps">
            <h3>ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š</h3>
            <ol>
                <li>æ£€æŸ¥ CI Gate å·¥ä½œæµçš„è¿è¡ŒçŠ¶æ€</li>
                <li>ç¡®ä¿ CI Gate ä¸­æ­£ç¡®æ‰§è¡Œäº†æ„å»ºæ­¥éª¤</li>
                <li>éªŒè¯æ„å»ºäº§ç‰©æ˜¯å¦ä¸Šä¼ ä¸º "build-artifact"</li>
                <li>ç¡®è®¤åˆ¶å“ä¸­åŒ…å« dist ç›®å½•æˆ– index.html æ–‡ä»¶</li>
            </ol>
        </div>
    </div>
</body>
</html>
EOF
            echo "DEPLOY_PATH=./dist" >> $GITHUB_ENV
          fi
          
          echo "âœ… éƒ¨ç½²è·¯å¾„è®¾ç½®ä¸º: $DEPLOY_PATH"
      
      - name: ğŸš€ Upload artifact and deploy
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.DEPLOY_PATH }}
        
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
