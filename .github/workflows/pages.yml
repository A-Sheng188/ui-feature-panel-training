name: ğŸš€ Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["ğŸ”’ CI Gate"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ› ï¸ Setup Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¥ Download artifact from successful CI run
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          # æ·»åŠ è¿™è¡Œæ¥æŒ‡å®šåˆ¶å“åç§°ï¼ˆå¦‚æœCI Gateä¸Šä¼ äº†ç‰¹å®šåç§°çš„åˆ¶å“ï¼‰
          # name: build
      
      - name: ğŸ” å½»åº•æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶ç»“æ„
        id: inspect
        run: |
          echo "======================================"
          echo "ğŸ“ å®Œæ•´çš„å½“å‰ç›®å½•ç»“æ„"
          echo "======================================"
          pwd
          ls -la
          
          echo ""
          echo "======================================"
          echo "ğŸ” é€’å½’æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•"
          echo "======================================"
          find . -type f 2>/dev/null | head -50
          
          echo ""
          echo "======================================"
          echo "ğŸ“Š ç»Ÿè®¡æ–‡ä»¶ç±»å‹"
          echo "======================================"
          echo "HTMLæ–‡ä»¶:"
          find . -name "*.html" 2>/dev/null
          echo ""
          echo "JavaScriptæ–‡ä»¶:"
          find . -name "*.js" 2>/dev/null | head -10
          echo ""
          echo "CSSæ–‡ä»¶:"
          find . -name "*.css" 2>/dev/null | head -10
          
          echo ""
          echo "======================================"
          echo "ğŸ“‚ æ£€æŸ¥æ‰€æœ‰å­ç›®å½•çš„å†…å®¹"
          echo "======================================"
          for dir in $(find . -type d -maxdepth 2 2>/dev/null); do
            echo "ç›®å½•: $dir"
            ls -la "$dir/" 2>/dev/null | head -5
            echo "---"
          done
      
      - name: ğŸ“¦ ç¡®å®šæ­£ç¡®çš„ä¸Šä¼ è·¯å¾„
        id: find-path
        run: |
          # æŸ¥æ‰¾åŒ…å«index.htmlçš„ç›®å½•
          HTML_DIRS=$(find . -name "index.html" -type f 2>/dev/null | xargs dirname 2>/dev/null | head -5)
          
          echo "æ‰¾åˆ°åŒ…å«index.htmlçš„ç›®å½•:"
          for dir in $HTML_DIRS; do
            echo "- $dir"
          done
          
          if [ -z "$HTML_DIRS" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°index.htmlæ–‡ä»¶"
            echo "DEPLOY_PATH=./" >> $GITHUB_ENV
            echo "WARNING=no-html-found" >> $GITHUB_ENV
          else
            # å–ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç›®å½•
            FIRST_DIR=$(echo "$HTML_DIRS" | head -1)
            echo "âœ… é€‰æ‹©éƒ¨ç½²ç›®å½•: $FIRST_DIR"
            echo "DEPLOY_PATH=$FIRST_DIR" >> $GITHUB_ENV
            echo "WARNING=none" >> $GITHUB_ENV
            
            # åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if [ ! -f "$FIRST_DIR/index.html" ]; then
              echo "åˆ›å»ºæµ‹è¯•index.htmlæ–‡ä»¶"
              cat > "$FIRST_DIR/index.html" << EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pages</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; text-align: center; }
        h1 { color: #0366d6; }
        .success { color: green; }
        .info { background: #f6f8fa; padding: 20px; border-radius: 5px; margin: 20px auto; max-width: 600px; }
    </style>
</head>
<body>
    <h1>ğŸš€ GitHub Pages éƒ¨ç½²æˆåŠŸï¼</h1>
    <div class="info">
        <p class="success">âœ… éƒ¨ç½²å·¥ä½œæµæ­£åœ¨è¿è¡Œ</p>
        <p>è¿™æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•é¡µé¢ã€‚</p>
        <p>è¯·æ£€æŸ¥æ‚¨çš„ CI Gate å·¥ä½œæµæ˜¯å¦ç”Ÿæˆäº†æ­£ç¡®çš„æ„å»ºæ–‡ä»¶ã€‚</p>
    </div>
</body>
</html>
EOF
            fi
          fi
          
          echo "ä½¿ç”¨çš„éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
      
      - name: ğŸš€ Upload artifact and deploy
        uses: actions/upload-pages-artifact@v3
        with:
          # ä½¿ç”¨åŠ¨æ€ç¡®å®šçš„è·¯å¾„
          path: ${{ env.DEPLOY_PATH }}
        
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
